{==============================================================================
  AUTOMAÇÃO COMPOSTA (ORQUESTRADOR) - PERFIL MODERADO
  
  Versão: 8.2 (Diagnóstico com ConsoleLog)
  Autor: Gemini (assistente Trader-Dev NTSL)
==============================================================================}

Input
  // -------- IDENTIFICAÇÃO --------
  numeroMagico(202408);
  nomeEstrategia("ORQUESTRADOR_MODERADO_8_ADAPTATIVO");

  // -------- ATIVO (CONFIGURAR MANUALMENTE) --------
  pontosPorTick(0.2);
  custoPorContrato(0.85);

  // -------- GERENCIAMENTO DE POSIÇÃO ADAPTATIVO (SOROS PARCIAL) --------
  usarAumentoAposGain(True);
  gains_para_aumentar(2);      // Nº de vitorias seguidas para aumentar a mão
  contratos_adicionais(1);     // Nº de contratos para adicionar
  max_contratos(4);              // Nº máximo de contratos por operação
  soros_fatorAtrStop(1.0);       // Fator de ATR do Stop para trades com mão aumentada

  // -------- MOTOR DE RISCO GLOBAL --------
  riscoMaximoDiario(300.0);
  lucroMaximoDiario(600.0);
  maxTradesPorDia(15);
  maxLossConsecutivo(3);
  
  // -------- GESTÃO DE SESSÃO E HORÁRIOS --------
  usarJanelaHoraria(True);
  horaInicioGlobal(0905);
  horaFimGlobal(1745);
  horaEncerramento(1750);

  // -------- ORQUESTRADOR E PESOS --------
  scoreMinimoEntrada(0.5);
  peso_LarryWilliams(0.4);
  peso_PrimeiraBarra(0.3);
  peso_Bollinger(0.3);

  // -------- GESTÃO DE TRADE (POR OPERAÇÃO) --------
  contratosPorOperacao(1); // Tamanho base da posição
  usarStopLoss(True);
  fatorAtrStop(2.0);
  usarStopGain(True);
  fatorAtrGain(3.0);
  usarBreakEven(True);
  gatilhoBreakevenAtr(0.8);
  usarTrailingStop(True);
  gatilhoTrailingAtr(1.5);
  distanciaTrailingAtr(1.2);

  // -------- PARÂMETROS DAS ESTRATÉGIAS INTERNAS --------
  lw_mediaTendencia(20);
  lw_mediaSinal(3);
  pb_horaInicio(0900);
  pb_horaFim(0915);
  bb_periodo(20);
  bb_desvio(2.0);
  bb_tipoMedia(1);

  // -------- FILTROS GERAIS DE ENTRADA --------
  usarFiltroRegime(True);   // Filtro de regime de volatilidade
  regime_atr_curto(14);
  regime_atr_longo(100);
  regime_fator_minimo(0.8); // Ex: 0.8 = só para se vol < 80% da média
  usarFiltroADX(True);      // Filtro de força da tendência
  adx_periodo(14);          // Usado para ADX e para o novo filtro DI+/DI-
  adx_nivel_minimo(20);
  usarFiltroRSI(True);      // Lógica de veto em exaustão com RSI
  rsi_periodo(14);
  rsi_nivel_sobrecompra(70);
  rsi_nivel_sobrevenda(15); // Nível mais baixo para permitir vendas
  filtro_volatilidade_atrPeriodo(14);
  filtro_spreadMaximoTicks(999); // Filtro desativado

Var
  // --- Variáveis de Estado (Persistem entre os candles) ---
  ultimoDia, tradesHoje, lossConsecutivo: Integer;
  bloqueadoMeta, bloqueadoLossConsec, posicaoAberta: Boolean;
  resultadoDiario, resultadoUltimoTrade: Float;
  precoEntrada, precoStopLoss, precoStopGain, precoTrailingStop: Float;
  maximaPrimeiraBarra, minimaPrimeiraBarra: Float;
  primeiraBarraDefinida, pb_trade_hoje: Boolean;
  winsConsecutivos: Integer; // Para gerenciamento de posição

  // --- Variáveis de Loop (movidas para global) ---
  horaAtual: Integer;
  atr_trade: Float;
  sinalLW, sinalPB, sinalBB: Integer;
  scoreCompra, scoreVenda: Float;
  podeEntrar: Boolean;
  novoTrailing: Float;
  adx_valor, rsi_valor: Float;
  di_plus, di_minus: Float;    // Para novo filtro de tendência
  atr_curto, atr_longo: Float; // Para filtro de regime
  scoreMinimoEntrada_var: Float;
  contratosCalculado: Integer; // Para gerenciamento de posição
  fator_stop_usado: Float;     // Para stop de proteção

// ======== FUNÇÕES DE SINAL========

function Sinal_LarryWilliams(pMediaTend: Integer; pMediaSinal: Integer): Integer;
var
  tendencia, mediaSinalCompra, mediaSinalVenda: Float;
begin
  tendencia := XAverage(pMediaTend, Close); 
  mediaSinalCompra := Media(pMediaSinal, Low);
  mediaSinalVenda := Media(pMediaSinal, High);
  if (Close > tendencia) and (Low < mediaSinalCompra) then
    Result := 1
  else if (Close < tendencia) and (High > mediaSinalVenda) then
    Result := -1
  else
    Result := 0;
end;

function Sinal_PrimeiraBarra(pMaxPB: Float; pMinPB: Float; pDefinida: Boolean; pStartTime: Integer; pTradeJaFeito: Boolean): Integer;
begin
  if (pTradeJaFeito) then Result := 0;   
  if (not pDefinida) or (Time <= pStartTime) then
    Result := 0
  else
  begin
    if (High > pMaxPB) then Result := 1
    else if (Low < pMinPB) then Result := -1
    else Result := 0;
  end;
end;

function Sinal_BollingerBreakout(pPeriodo: Integer; pDesvio: Float; pTipo: Integer): Integer;
var
  bandaSup, bandaInf: Float;
begin
  bandaSup := BollingerBands(pDesvio, pPeriodo, pTipo)|0|;
  bandaInf := BollingerBands(pDesvio, pPeriodo, pTipo)|1|;
  if (Close > bandaSup) then Result := 1
  else if (Close < bandaInf) then Result := -1
  else Result := 0;
end;

// ======== BLOCO PRINCIPAL DE EXECUÇÃO ========
begin
  // --- 0. INICIALIZAÇÃO DE VARIÁVEIS ---
  scoreMinimoEntrada_var := scoreMinimoEntrada;

  // --- 1. LÓGICAS DE INICIALIZAÇÃO E TRANSIÇÃO DE BARRA ---
  if (Date <> ultimoDia) then
  begin
    ultimoDia := Date;
    tradesHoje := 0;
    lossConsecutivo := 0;
    resultadoDiario := 0.0;
    bloqueadoMeta := False;
    bloqueadoLossConsec := False;
    primeiraBarraDefinida := False;
    pb_trade_hoje := False;
    maximaPrimeiraBarra := 0.0;
    minimaPrimeiraBarra := 999999.0;
    winsConsecutivos := 0; // Zera o contador de wins no início do dia
    contratosCalculado := contratosPorOperacao;
  end;

  if (posicaoAberta and (Position() = 0)) then
  begin
    posicaoAberta := False;
    resultadoUltimoTrade := OpenResult() * pontosPorTick - custoPorContrato;
    resultadoDiario := resultadoDiario + resultadoUltimoTrade;
    ConsoleLog("Trade Fechado. Resultado em Pontos: " + OpenResult(), clBlue);

    // Lógica para contadores de wins e losses
    if (OpenResult() > 0) then // Trade com lucro em pontos
    begin
      winsConsecutivos := winsConsecutivos + 1;
      lossConsecutivo := 0;
      ConsoleLog("CONTADOR: Trade Vencedor. Wins Consecutivos agora: " + winsConsecutivos, clGreen);
    end
    else // Trade com prejuízo ou zero a zero em pontos
    begin
      winsConsecutivos := 0;
      ConsoleLog("CONTADOR: Trade Perdedor/Empate. Wins Consecutivos ZERADO.", clRed);
      if (resultadoUltimoTrade < 0) then // Apenas incrementa loss consecutivo se houve perda líquida
        lossConsecutivo := lossConsecutivo + 1
      else
        lossConsecutivo := 0;
    end;
  end;

  // --- 2. MOTOR DE RISCO GLOBAL E GESTÃO DE SESSÃO ---
  horaAtual := Time;
  if (horaAtual >= horaEncerramento) and (Position() <> 0) then ClosePosition();
  if (not bloqueadoMeta) then
  begin
    if ((lucroMaximoDiario > 0) and (resultadoDiario >= lucroMaximoDiario)) then bloqueadoMeta := True;
    if ((riscoMaximoDiario > 0) and (resultadoDiario <= -riscoMaximoDiario)) then bloqueadoMeta := True;
  end;
  if (lossConsecutivo >= maxLossConsecutivo) and (not bloqueadoLossConsec) then
    bloqueadoLossConsec := True;

  // --- 3. LÓGICA DE ESTRATÉGIAS E SINAIS ---
  if (horaAtual >= pb_horaInicio) and (horaAtual <= pb_horaFim) then
  begin
    if (High > maximaPrimeiraBarra) then maximaPrimeiraBarra := High;
    if (Low < minimaPrimeiraBarra) then minimaPrimeiraBarra := Low;
  end;
  if (horaAtual > pb_horaFim) and (not primeiraBarraDefinida) and (maximaPrimeiraBarra > 0) then
    primeiraBarraDefinida := True;

  // --- 4. GESTÃO DE POSIÇÃO E ENTRADAS ---
  if (posicaoAberta) then
  begin
    atr_trade := AvgTrueRange(filtro_volatilidade_atrPeriodo, 0);
    if (usarBreakEven) then
    begin
      if (Position() > 0) and (Close >= precoEntrada + (atr_trade * gatilhoBreakevenAtr)) and (precoStopLoss < precoEntrada) then precoStopLoss := precoEntrada;
      if (Position() < 0) and (Close <= precoEntrada - (atr_trade * gatilhoBreakevenAtr)) and (precoStopLoss > precoEntrada) then precoStopLoss := precoEntrada;
    end;
    if (usarTrailingStop) then
    begin
      if (Position() > 0) and (Close >= precoEntrada + (atr_trade * gatilhoTrailingAtr)) then
      begin
        novoTrailing := Close - (atr_trade * distanciaTrailingAtr);
        if (novoTrailing > precoTrailingStop) then precoTrailingStop := novoTrailing;
      end
      else if (Position() < 0) and (Close <= precoEntrada - (atr_trade * gatilhoTrailingAtr)) then
      begin
        novoTrailing := Close + (atr_trade * distanciaTrailingAtr);
        if (novoTrailing < precoTrailingStop) then precoTrailingStop := novoTrailing;
      end;
    end;
    if (Position() > 0) and ((usarStopLoss and (Close <= precoStopLoss)) or (usarStopGain and (Close >= precoStopGain)) or (usarTrailingStop and (Close <= precoTrailingStop))) then
      ClosePosition()
    else if (Position() < 0) and ((usarStopLoss and (Close >= precoStopLoss)) or (usarStopGain and (Close <= precoStopGain)) or (usarTrailingStop and (Close >= precoTrailingStop))) then
      ClosePosition();
  end
  else if (not bloqueadoMeta) and (not bloqueadoLossConsec) and (tradesHoje < maxTradesPorDia) and ((not usarJanelaHoraria) or ((horaAtual >= horaInicioGlobal) and (horaAtual < horaFimGlobal))) then
  begin
    podeEntrar := True;

    // FILTRO 0: Regime de Volatilidade
    if (usarFiltroRegime) then
    begin
      atr_curto := AvgTrueRange(regime_atr_curto, 0);
      atr_longo := AvgTrueRange(regime_atr_longo, 0);
      if (atr_curto < (atr_longo * regime_fator_minimo)) then
        podeEntrar := False;
    end;

    // FILTRO 1: Força da Tendência com ADX
    if (podeEntrar and usarFiltroADX) then
    begin
      adx_valor := ADX(adx_periodo, 1);
      if (adx_valor < adx_nivel_minimo) then
        podeEntrar := False;
    end;

    if (podeEntrar) then
    begin
      // --- CÁLCULO DE TAMANHO DA POSIÇÃO (SOROS PARCIAL) ---
      ConsoleLog("Preparando novo trade. Wins Consecutivos em memória: " + winsConsecutivos, clBlue);
      contratosCalculado := contratosPorOperacao;
      if (usarAumentoAposGain and (winsConsecutivos >= gains_para_aumentar)) then
      begin
        contratosCalculado := contratosPorOperacao + contratos_adicionais;
        if (contratosCalculado > max_contratos) then
          contratosCalculado := max_contratos;
        ConsoleLog("SOROS ATIVADO! Calculado " + contratosCalculado + " contratos.", clFuchsia);
      end;

      // --- CÁLCULO DE SINAIS E SCORES ---
      sinalLW := Sinal_LarryWilliams(lw_mediaTendencia, lw_mediaSinal);
      sinalPB := Sinal_PrimeiraBarra(maximaPrimeiraBarra, minimaPrimeiraBarra, primeiraBarraDefinida, pb_horaInicio, pb_trade_hoje);
      sinalBB := Sinal_BollingerBreakout(bb_periodo, bb_desvio, bb_tipoMedia);

      scoreCompra := 0; scoreVenda := 0;
      if (sinalLW = 1) then scoreCompra := scoreCompra + peso_LarryWilliams;
      if (sinalLW = -1) then scoreVenda := scoreVenda + peso_LarryWilliams;
      if (sinalPB = 1) then scoreCompra := scoreCompra + peso_PrimeiraBarra;
      if (sinalPB = -1) then scoreVenda := scoreVenda + peso_PrimeiraBarra;
      if (sinalBB = 1) then scoreCompra := scoreCompra + peso_Bollinger;
      if (sinalBB = -1) then scoreVenda := scoreVenda + peso_Bollinger;

      // --- LÓGICA DE FILTROS EM SINERGIA ---

      // FILTRO 2: Veto de Exaustão com RSI
      if (usarFiltroRSI) then
      begin
        rsi_valor := RSI(rsi_periodo, 1);
        if (rsi_valor >= rsi_nivel_sobrecompra) then scoreCompra := 0;
        if (rsi_valor <= rsi_nivel_sobrevenda) then scoreVenda := 0;
      end;

      // FILTRO 3: Veto de Direção com Sistema Direcional (DI+/DI-)
      di_plus := DiPDiM(adx_periodo)|0|;
      di_minus := DiPDiM(adx_periodo)|1|;

      if (di_plus < di_minus) then scoreCompra := 0;
      if (di_minus < di_plus) then scoreVenda := 0;

      // --- EXECUÇÃO DA ORDEM ---
      atr_trade := AvgTrueRange(filtro_volatilidade_atrPeriodo, 0);

      // Define o fator de Stop a ser usado (Normal ou de Proteção)
      fator_stop_usado := fatorAtrStop;
      if (usarAumentoAposGain and (contratosCalculado > contratosPorOperacao)) then
        fator_stop_usado := soros_fatorAtrStop;

      if (scoreCompra >= scoreMinimoEntrada_var) and (scoreCompra > scoreVenda) then
      begin
        BuyAtMarket(contratosCalculado);
        precoEntrada := Close;
        precoStopLoss := precoEntrada - (atr_trade * fator_stop_usado);
        precoStopGain := precoEntrada + (atr_trade * fatorAtrGain);
        precoTrailingStop := precoStopLoss;
        posicaoAberta := True;
        tradesHoje := tradesHoje + 1;
        if (sinalPB <> 0) then pb_trade_hoje := True;
      end
      else if (scoreVenda >= scoreMinimoEntrada_var) and (scoreVenda > scoreCompra) then
      begin
        SellShortAtMarket(contratosCalculado);
        precoEntrada := Close;
        precoStopLoss := precoEntrada + (atr_trade * fator_stop_usado);
        precoStopGain := precoEntrada - (atr_trade * fatorAtrGain);
        precoTrailingStop := precoStopLoss;
        posicaoAberta := True;
        tradesHoje := tradesHoje + 1;
        if (sinalPB <> 0) then pb_trade_hoje := True;
      end;
    end;
  end;
end;